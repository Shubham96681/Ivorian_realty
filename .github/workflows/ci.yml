name: CI - Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  NODE_VERSION: '18.x'

jobs:
  # Build and test shared library first
  shared-lib:
    name: Build Shared Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Ivorian_realty/backend/microservices/shared-lib/package-lock.json

      - name: Install dependencies
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: npm ci

      - name: Lint
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: npm run lint || true

      - name: Build
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: npm run build

      - name: Test
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: npm test || true

  # Build and test API Gateway
  api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    needs: shared-lib
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Ivorian_realty/backend/microservices/api-gateway/package-lock.json

      - name: Build shared library
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: |
          npm ci
          npm run build

      - name: Install dependencies
        working-directory: Ivorian_realty/backend/microservices/api-gateway
        run: npm ci

      - name: Lint
        working-directory: Ivorian_realty/backend/microservices/api-gateway
        run: npm run lint || true

      - name: Build
        working-directory: Ivorian_realty/backend/microservices/api-gateway
        run: npm run build

      - name: Test
        working-directory: Ivorian_realty/backend/microservices/api-gateway
        run: npm test || true

  # Build and test Auth Service
  auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    needs: shared-lib
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Ivorian_realty/backend/microservices/auth-service/package-lock.json

      - name: Build shared library
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: |
          npm ci
          npm run build

      - name: Install dependencies
        working-directory: Ivorian_realty/backend/microservices/auth-service
        run: npm ci

      - name: Lint
        working-directory: Ivorian_realty/backend/microservices/auth-service
        run: npm run lint || true

      - name: Build
        working-directory: Ivorian_realty/backend/microservices/auth-service
        run: npm run build

      - name: Test
        working-directory: Ivorian_realty/backend/microservices/auth-service
        run: npm test || true

  # Build and test Property Service
  property-service:
    name: Build Property Service
    runs-on: ubuntu-latest
    needs: shared-lib
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Ivorian_realty/backend/microservices/property-service/package-lock.json

      - name: Build shared library
        working-directory: Ivorian_realty/backend/microservices/shared-lib
        run: |
          npm ci
          npm run build

      - name: Install dependencies
        working-directory: Ivorian_realty/backend/microservices/property-service
        run: npm ci

      - name: Lint
        working-directory: Ivorian_realty/backend/microservices/property-service
        run: npm run lint || true

      - name: Build
        working-directory: Ivorian_realty/backend/microservices/property-service
        run: npm run build

      - name: Test
        working-directory: Ivorian_realty/backend/microservices/property-service
        run: npm test || true

  # Build and test Frontend
  frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Ivorian_realty/frontend/package-lock.json

      - name: Install dependencies
        working-directory: Ivorian_realty/frontend
        run: npm ci

      - name: Lint
        working-directory: Ivorian_realty/frontend
        run: npm run lint || true

      - name: Build
        working-directory: Ivorian_realty/frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: Ivorian_realty/frontend/dist
          retention-days: 7

  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [shared-lib, api-gateway, auth-service, property-service, frontend]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "Build Summary:"
          echo "Shared Library: ${{ needs.shared-lib.result }}"
          echo "API Gateway: ${{ needs.api-gateway.result }}"
          echo "Auth Service: ${{ needs.auth-service.result }}"
          echo "Property Service: ${{ needs.property-service.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"

